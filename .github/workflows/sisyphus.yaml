name: CloudWaddie Agent

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Custom prompt"
        required: false
  issue_comment:
    types: [created]

jobs:
  agent:
    runs-on: ubuntu-latest
    environment: sisyphus-env
    
    # Trigger on @cloudwaddie-ai
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
        contains(github.event.comment.body || '', '@cloudwaddie-ai') &&
        (github.event.comment.user.login || '') != 'cloudwaddie-ai' &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || ''))

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "cloudwaddie-ai"
          git config user.email "cloudwaddie-ai@users.noreply.github.com"

      - name: Setup Runtime
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends tmux jq
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Clone and Build oh-my-opencode
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          # Clone the specific version/repo you provided
          git clone https://github.com/code-yeongyu/oh-my-opencode.git .tmp-omo
          cd .tmp-omo
          bun install
          bun run build
          
          # Move artifacts to workspace root
          mv dist ../dist
          mv node_modules ../node_modules
          mv package.json ../package.json
          cd ..
          rm -rf .tmp-omo

      - name: Setup OpenCode & Config
        env:
          ANTIGRAVITY_AUTH: ${{ secrets.ANTIGRAVITY_AUTH_JSON }}
        run: |
          export PATH="$HOME/.bun/bin:$HOME/.opencode/bin:$PATH"
          
          # 1. Install Dependencies
          bun add opencode-antigravity-auth@1.2.7
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
          # 2. Initialize Default Config
          bun run dist/cli/index.js install --no-tui --gemini=no --chatgpt=no --claude=no
          
          # 3. Patch opencode.json (The Core Config)
          # FIX: We ensure 'provider' is an OBJECT, not a string, to prevent the previous crash
          CONFIG_PATH=~/.config/opencode/opencode.json
          PLUGIN_PATH="file://$(pwd)/node_modules/opencode-antigravity-auth"
          
          # Register Plugin
          jq --arg plugin "$PLUGIN_PATH" '
            if .plugin == null then .plugin = [$plugin] 
            elif (.plugin | type) == "array" then .plugin += [$plugin] 
            else .plugin = [$plugin] 
            end | .plugin |= unique' "$CONFIG_PATH" > "$CONFIG_PATH.tmp" && mv "$CONFIG_PATH.tmp" "$CONFIG_PATH"
          
          # Register Google Provider (Correct Object Structure)
          jq '.provider.google = {
            "name": "Google",
            "models": {
              "gemini-3-pro-high": {
                "name": "Gemini 3 Pro High",
                "thinking": true,
                "limit": { "context": 1048576, "output": 65535 }
              }
            }
          }' "$CONFIG_PATH" > "$CONFIG_PATH.tmp" && mv "$CONFIG_PATH.tmp" "$CONFIG_PATH"
          
          # 4. Patch oh-my-opencode.json (The Agent Config) - Set Primary Model
          OMO_CONFIG=~/.config/opencode/oh-my-opencode.json
          jq '.agents.Sisyphus.model = "google/gemini-3-pro-high" | 
              .agents.Oracle.model = "google/gemini-3-pro-high" | 
              .agents.Librarian.model = "google/gemini-3-pro-high"' \
              "$OMO_CONFIG" > "$OMO_CONFIG.tmp" && mv "$OMO_CONFIG.tmp" "$OMO_CONFIG"

          # 5. Inject Session
          echo "$ANTIGRAVITY_AUTH" > ~/.config/opencode/antigravity-accounts.json

      - name: Collect Context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          ISSUE_DATA=$(gh api "repos/$REPO/issues/${ISSUE_NUM}")
          
          echo "type=$(echo "$ISSUE_DATA" | jq -e '.pull_request' > /dev/null && echo 'pr' || echo 'issue')" >> $GITHUB_OUTPUT
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "title=$(echo "$ISSUE_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
          echo "comment_id=${{ github.event.comment.id }}" >> $GITHUB_OUTPUT
          
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Feedback (Eyes)
        if: steps.context.outputs.comment_id != ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Run CloudWaddie Agent (With Fallback)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          export PATH="$HOME/.opencode/bin:$HOME/.bun/bin:$PATH"
          
          PROMPT=$(cat <<'EOF'
          <ultrawork-mode>
          [CODE RED] You are @cloudwaddie-ai.
          
          ## RULES
          - Deliver 100% working code. No demos.
          - Orchestrate sub-agents for exploration.
          </ultrawork-mode>

          ---
          Context: ${{ steps.context.outputs.title }} (#${{ steps.context.outputs.number }})
          Request from @${{ steps.context.outputs.author }}:
          ${{ steps.context.outputs.comment }}
          EOF
          )

          # --- EXECUTION BLOCK WITH FALLBACK ---
          
          echo "ðŸš€ Attempting Primary Run (Antigravity Bridge)..."
          
          # Turn off immediate exit so we can catch the failure
          set +e 
          
          # Stream output using stdbuf
          stdbuf -oL -eL bun run dist/cli/index.js run "$PROMPT"
          EXIT_CODE=$?
          
          set -e # Turn error checking back on
          
          # Check if it failed
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ Primary Agent Failed (Exit Code: $EXIT_CODE). Initiating Fallback Protocol..."
            
            # Reconfigure Agent to use the Built-in Big Pickle Model
            OMO_CONFIG=~/.config/opencode/oh-my-opencode.json
            echo "ðŸ”„ Switching configuration to 'opencode/big-pickle'..."
            
            jq '.agents.Sisyphus.model = "opencode/big-pickle" | 
                .agents.Oracle.model = "opencode/big-pickle" | 
                .agents.Librarian.model = "opencode/big-pickle"' \
                "$OMO_CONFIG" > "$OMO_CONFIG.tmp" && mv "$OMO_CONFIG.tmp" "$OMO_CONFIG"
            
            echo "ðŸ¥’ Restarting Agent with Fallback Model..."
            
            # Retry the run command
            stdbuf -oL -eL bun run dist/cli/index.js run "$PROMPT"
          else
            echo "âœ… Primary Agent finished successfully."
          fi

      - name: Feedback (Done)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "${{ steps.context.outputs.comment_id }}" ]]; then
            gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              -X POST -f content="+1" || true
          fi
